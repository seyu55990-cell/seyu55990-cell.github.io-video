<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Reader - éŸ³è§†é¢‘é˜…è¯»å™¨</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: #fff;
    color: #333;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .top-bar {
    background: #f8f9fa;
    padding: 12px 20px;
    border-bottom: 1px solid #eaeaea;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .left-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex: 1;
  }

  .right-controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .file-btn {
    padding: 8px 16px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
    position: relative;
  }

  .media-container {
    flex: 1;
    min-width: 200px;
    max-width: 100%;
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
  }

  .media-player {
    width: 100%;
    background: #000;
    border-radius: 6px;
    overflow: hidden;
  }

  #mediaPlayer.video-mode {
    height: 240px;
    max-height: 40vh;
  }

  #mediaPlayer.audio-mode {
    height: 36px;
  }

  .media-type-indicator {
    font-size: 12px;
    color: #666;
    text-align: center;
    padding: 2px 6px;
    background: #f0f0f0;
    border-radius: 4px;
    align-self: flex-start;
  }

  .follow-btn {
    padding: 8px 12px;
    background: #4a90e2;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.2s;
  }

  .follow-btn:hover { background: #3a7bc8; }
  .follow-btn:active { background: #2a6bb0; }
  .follow-btn.active {
    background: #2a6bb0;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }

  .text-area {
    flex: 1;
    padding: 30px 60px;
    overflow-y: auto;
    line-height: 1.6;
    font-size: 15px;
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
    user-select: text;
  }

  .line { margin: 14px 0; padding: 10px 0; }
  .line.active-line { background: rgba(74,144,226,0.02); }

  .word {
    display: inline;
    margin: 0 1px;
    padding: 0;
    font-weight: 600;
    font-family: 'Segoe UI', Roboto, -apple-system, sans-serif;
  }

  .word.current {
    color: #ffcc00 !important;
    font-weight: 600;
    background: none !important;
  }

  .punctuation { margin: 0 1px; }

  .loading {
    color: #666;
    text-align: center;
    padding: 40px;
    font-size: 15px;
  }

  .hidden-input { 
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* é”™è¯¯é¢æ¿æ ·å¼ */
  .error-panel {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 6px;
    padding: 15px;
    margin: 10px 0;
  }
  
  .error-panel strong {
    color: #721c24;
  }
  
  .error-panel p {
    margin: 10px 0;
    color: #721c24;
  }
  
  .action-btn {
    margin: 5px;
    padding: 8px 12px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .action-btn.detect {
    background: #17a2b8;
  }
  
  .action-btn.success {
    background: #28a745;
  }

  @media (max-width: 768px) {
    .top-bar {
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
    }
    
    .left-controls {
      flex-direction: column;
      align-items: stretch;
    }
    
    .text-area {
      padding: 20px;
    }
    
    #mediaPlayer.video-mode {
      height: 200px;
    }
  }
</style>
</head>
<body>

<div class="top-bar">
  <div class="left-controls">
    <label class="file-btn">
      ğŸ¬ éŸ³è§†é¢‘
      <input type="file" id="mediaFile" accept="audio/*,video/*" class="hidden-input">
    </label>

    <label class="file-btn">
      ğŸ“„ å­—å¹•
      <input type="file" id="srtFile" accept=".srt,.txt" class="hidden-input">
    </label>

    <div class="media-container">
      <div class="media-type-indicator" id="mediaTypeIndicator">æœªåŠ è½½åª’ä½“</div>
      <video id="mediaPlayer" controls class="media-player audio-mode" preload="metadata">
        <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HTML5 è§†é¢‘/éŸ³é¢‘æ’­æ”¾ã€‚</p>
      </video>
    </div>
  </div>

  <div class="right-controls">
    <button id="followBtn" class="follow-btn" title="ç‚¹å‡»æ»šåŠ¨åˆ°å½“å‰æ’­æ”¾ä½ç½®">ğŸ“Œ</button>
  </div>
</div>

<div class="text-area" id="textArea">
  <div class="loading">ä¸Šä¼ éŸ³è§†é¢‘æ–‡ä»¶å’Œå­—å¹•æ–‡ä»¶å¼€å§‹é˜…è¯»</div>
</div>

<script>
// ç­‰å¾…DOMåŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
  console.log('Media Reader åˆå§‹åŒ–...');
  
  // å…¨å±€å˜é‡
  let subtitles = [];
  let currentLineIndex = -1;
  let followMode = false;
  let isVideo = false;
  
  // è·å–DOMå…ƒç´ 
  const mediaPlayer = document.getElementById('mediaPlayer');
  const followBtn = document.getElementById('followBtn');
  const textArea = document.getElementById('textArea');
  const mediaFileInput = document.getElementById('mediaFile');
  const srtFileInput = document.getElementById('srtFile');
  const mediaTypeIndicator = document.getElementById('mediaTypeIndicator');
  
  // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
  if (!mediaPlayer || !followBtn || !textArea) {
    console.error('æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
    return;
  }
  
  console.log('æ‰€æœ‰DOMå…ƒç´ åŠ è½½æˆåŠŸ');

  // è§£ææ—¶é—´å‡½æ•°
  function parseTime(h, m, s, ms) {
    return parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(s) + parseInt(ms || 0) / 1000;
  }

  // è§£æSRTæ–‡ä»¶
  function parseSRT(text) {
    console.log('å¼€å§‹è§£æSRTæ–‡ä»¶...');
    const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
    const result = [];
    let i = 0;
    
    while (i < lines.length) {
      while (i < lines.length && lines[i].trim() === '') i++;
      if (i >= lines.length) break;
      
      const indexLine = lines[i].trim();
      if (!/^\d+$/.test(indexLine)) {
        i++;
        continue;
      }
      i++;
      
      if (i >= lines.length) break;
      
      const timeLine = lines[i];
      let timeMatch = timeLine.match(/(\d{2}):(\d{2}):(\d{2})[,.](\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})[,.](\d{3})/);
      
      if (!timeMatch) {
        timeMatch = timeLine.match(/(\d{2}):(\d{2}):(\d{2})\.(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})\.(\d{3})/);
      }
      
      if (!timeMatch) {
        timeMatch = timeLine.match(/(\d{2}):(\d{2}):(\d{2})\s*-->\s*(\d{2}):(\d{2}):(\d{2})/);
        if (timeMatch) {
          timeMatch[4] = '000';
          timeMatch[8] = '000';
        }
      }
      
      if (!timeMatch) {
        console.warn('æ— æ³•è§£ææ—¶é—´è¡Œ:', timeLine);
        i++;
        continue;
      }
      
      const start = parseTime(timeMatch[1], timeMatch[2], timeMatch[3], timeMatch[4]);
      const end = parseTime(timeMatch[5], timeMatch[6], timeMatch[7], timeMatch[8]);
      i++;
      
      if (i >= lines.length) break;
      
      const textLines = [];
      while (i < lines.length && lines[i].trim() !== '' && !/^\d+$/.test(lines[i].trim())) {
        textLines.push(lines[i].trim());
        i++;
      }
      
      const text = textLines.join(' ');
      const words = splitIntoWords(text);
      
      if (words.length > 0) {
        result.push({
          index: parseInt(indexLine),
          start: start,
          end: end,
          text: text,
          words: words,
          duration: end - start
        });
      }
    }
    
    console.log(`è§£æå®Œæˆï¼Œå…± ${result.length} æ¡å­—å¹•`);
    return result;
  }

  // åˆ†å‰²æ–‡æœ¬ä¸ºå•è¯
  function splitIntoWords(text) {
    const regex = /([\w'-]+|[.,!?;:"'])/g;
    const matches = text.match(regex) || [];
    return matches.map(m => 
      /^[.,!?;:"']$/.test(m) ? { type: 'punctuation', text: m } : { type: 'word', text: m }
    );
  }

  // ä¿®æ­£æ—¶é—´æˆ³
  function fixTimestamps(subs, dur) {
    if (subs.length === 0) return subs;
    
    const last = subs[subs.length - 1].end;
    const needsFix = last > dur * 1.5 || subs[0].start > 3600;
    
    if (!needsFix) return subs;
    
    const first = subs[0].start;
    const hourOffset = Math.floor(first / 3600) * 3600;
    
    if (hourOffset > 0) {
      const testStart = subs[0].start - hourOffset;
      const testEnd = subs[subs.length - 1].end - hourOffset;
      
      if (testEnd <= dur * 1.1 && testStart >= 0) {
        return subs.map(s => ({
          ...s,
          start: Math.max(0, s.start - hourOffset),
          end: Math.max(0, s.end - hourOffset)
        }));
      }
    }
    
    const totalWords = subs.reduce((sum, s) => sum + s.words.filter(w => w.type === 'word').length, 0);
    const avgWordDur = dur / totalWords;
    let currentTime = 0;
    
    return subs.map(s => {
      const wc = s.words.filter(w => w.type === 'word').length;
      const durWord = wc * avgWordDur;
      const newSub = {
        ...s,
        start: currentTime,
        end: currentTime + durWord
      };
      currentTime += durWord;
      return newSub;
    });
  }

  // æ¸²æŸ“æ–‡æœ¬
  function renderText() {
    console.log('æ¸²æŸ“æ–‡æœ¬...', subtitles.length);
    
    if (subtitles.length === 0) {
      textArea.innerHTML = '<div class="loading">ä¸Šä¼ éŸ³è§†é¢‘æ–‡ä»¶å’Œå­—å¹•æ–‡ä»¶å¼€å§‹é˜…è¯»</div>';
      return;
    }
    
    let html = '';
    subtitles.forEach((sub, i) => {
      html += `<div class="line" id="line-${i}">`;
      sub.words.forEach((w, j) => {
        if (w.type === 'word') {
          html += `<span class="word" id="word-${i}-${j}">${w.text} </span>`;
        } else {
          html += `<span class="punctuation">${w.text} </span>`;
        }
      });
      html += '</div>';
    });
    
    textArea.innerHTML = html;
    console.log('æ–‡æœ¬æ¸²æŸ“å®Œæˆ');
  }

  // æ»šåŠ¨åˆ°å½“å‰è¡Œ
  function scrollToCurrentLine() {
    if (currentLineIndex === -1) return;
    
    const line = document.getElementById(`line-${currentLineIndex}`);
    if (!line) return;
    
    textArea.scrollTop = line.offsetTop - textArea.clientHeight / 2 + line.offsetHeight / 2;
  }

  // æ›´æ–°é«˜äº®
  function updateHighlight() {
    const t = mediaPlayer.currentTime;
    let newLineIndex = -1;
    
    for (let i = 0; i < subtitles.length; i++) {
      if (t >= subtitles[i].start && t < subtitles[i].end) {
        newLineIndex = i;
        break;
      }
    }
    
    if (newLineIndex !== currentLineIndex) {
      if (currentLineIndex !== -1) {
        const oldLine = document.getElementById(`line-${currentLineIndex}`);
        if (oldLine) oldLine.classList.remove('active-line');
      }
      
      if (newLineIndex !== -1) {
        const newLine = document.getElementById(`line-${newLineIndex}`);
        if (newLine) {
          newLine.classList.add('active-line');
          if (followMode) scrollToCurrentLine();
        }
      }
      
      currentLineIndex = newLineIndex;
    }
    
    document.querySelectorAll('.word.current').forEach(el => el.classList.remove('current'));
    
    if (currentLineIndex !== -1) {
      const sub = subtitles[currentLineIndex];
      const elapsed = t - sub.start;
      const progress = Math.min(elapsed / sub.duration, 0.999);
      const wordCount = sub.words.filter(w => w.type === 'word').length;
      
      if (wordCount > 0) {
        const wordIndex = Math.min(Math.floor(progress * wordCount), wordCount - 1);
        const wordEl = document.getElementById(`word-${currentLineIndex}-${wordIndex}`);
        if (wordEl) {
          wordEl.classList.add('current');
        }
      }
    }
  }

  // æ£€æµ‹è§†é¢‘ç¼–ç 
  async function detectVideoEncoding(file) {
    try {
      const buffer = await file.slice(0, 256).arrayBuffer();
      const bytes = new Uint8Array(buffer);
      
      // æ£€æµ‹å¸¸è§ç¼–ç 
      let encoding = 'æœªçŸ¥';
      let details = '';
      
      // æ£€æµ‹MP4å®¹å™¨
      if (bytes[4] === 0x66 && bytes[5] === 0x74 && bytes[6] === 0x79 && bytes[7] === 0x70) {
        // æ£€æµ‹H.265/HEVC
        if (bytes[8] === 0x68 && bytes[9] === 0x65 && bytes[10] === 0x76 && bytes[11] === 0x63) {
          encoding = 'HEVC/H.265';
          details = 'ä¸å…¼å®¹ âŒ - éœ€è¦è½¬æ¢ä¸ºH.264';
        }
        // æ£€æµ‹H.264/AVC
        else if (bytes[8] === 0x61 && bytes[9] === 0x76 && bytes[10] === 0x63 && bytes[11] === 0x31) {
          encoding = 'H.264/AVC';
          details = 'åº”å…¼å®¹ âœ…';
        }
        else {
          encoding = 'MP4 (æœªçŸ¥ç¼–ç )';
          details = 'å¯èƒ½éœ€è¦è½¬æ¢';
        }
      }
      
      return { encoding, details };
    } catch(e) {
      return { encoding: 'æ— æ³•æ£€æµ‹', details: 'æ–‡ä»¶è¯»å–å¤±è´¥' };
    }
  }

  // æ˜¾ç¤ºé”™è¯¯é¢æ¿
  function showErrorPanel(file, errorMsg) {
    // ç§»é™¤æ—§çš„é”™è¯¯é¢æ¿
    const oldPanel = document.querySelector('.error-panel');
    if (oldPanel) oldPanel.remove();
    
    const panel = document.createElement('div');
    panel.className = 'error-panel';
    panel.innerHTML = `
      <strong>æ— æ³•æ’­æ”¾ "${file.name}"</strong>
      <p>${errorMsg}</p>
      <p>å»ºè®®ï¼š</p>
      <ul style="margin:10px 0; padding-left:20px;">
        <li>ç‚¹å‡»"é™çº§ä¸ºéŸ³é¢‘"å°è¯•æ’­æ”¾å£°éŸ³</li>
        <li>ç”¨Edgeæµè§ˆå™¨æµ‹è¯•ï¼ˆæ”¯æŒæ›´å¤šæ ¼å¼ï¼‰</li>
        <li>è½¬æ¢ä¸ºH.264 MP4æ ¼å¼</li>
      </ul>
    `;
    
    const downgradeBtn = document.createElement('button');
    downgradeBtn.className = 'action-btn';
    downgradeBtn.innerHTML = 'ğŸ”‡ é™çº§ä¸ºéŸ³é¢‘æ’­æ”¾';
    downgradeBtn.onclick = function() {
      mediaPlayer.classList.remove('video-mode');
      mediaPlayer.classList.add('audio-mode');
      mediaTypeIndicator.textContent = 'éŸ³é¢‘æ¨¡å¼';
      alert('æ­£åœ¨å°è¯•ä»…æ’­æ”¾éŸ³é¢‘...');
      panel.remove();
    };
    
    const detectBtn = document.createElement('button');
    detectBtn.className = 'action-btn detect';
    detectBtn.innerHTML = 'ğŸ” æ£€æµ‹è§†é¢‘ç¼–ç ';
    detectBtn.onclick = async function() {
      const result = await detectVideoEncoding(file);
      alert(`æ£€æµ‹ç»“æœ:\næ–‡ä»¶: ${file.name}\nç¼–ç : ${result.encoding}\nçŠ¶æ€: ${result.details}\nå¤§å°: ${(file.size/1024/1024).toFixed(1)}MB`);
    };
    
    const testBtn = document.createElement('button');
    testBtn.className = 'action-btn success';
    testBtn.innerHTML = 'ğŸ¬ åŠ è½½æµ‹è¯•è§†é¢‘';
    testBtn.onclick = function() {
      mediaPlayer.src = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
      mediaPlayer.classList.remove('audio-mode');
      mediaPlayer.classList.add('video-mode');
      mediaTypeIndicator.textContent = 'è§†é¢‘æ¨¡å¼(æµ‹è¯•)';
      mediaPlayer.load();
      panel.remove();
      alert('æ­£åœ¨åŠ è½½æµ‹è¯•è§†é¢‘...å¦‚æœè¿™ä¸ªèƒ½æ’­ï¼Œè¯´æ˜é¡µé¢æ­£å¸¸ï¼Œæ˜¯ä½ çš„è§†é¢‘ç¼–ç é—®é¢˜ã€‚');
    };
    
    panel.appendChild(downgradeBtn);
    panel.appendChild(detectBtn);
    panel.appendChild(testBtn);
    
    document.querySelector('.media-container').appendChild(panel);
  }

  // å¢å¼ºç‰ˆåª’ä½“æ–‡ä»¶ä¸Šä¼ å¤„ç†
  mediaFileInput.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('åª’ä½“æ–‡ä»¶:', file.name, 'ç±»å‹:', file.type, 'å¤§å°:', (file.size/1024/1024).toFixed(1) + 'MB');
    
    // æ£€æŸ¥æ–‡ä»¶å¤§å°
    const maxSize = 1024 * 1024 * 1024; // 1GB
    if (file.size > maxSize) {
      if (!confirm(`æ–‡ä»¶è¾ƒå¤§ (${(file.size/(1024*1024*1024)).toFixed(2)}GB)ï¼Œå¯èƒ½å½±å“æ€§èƒ½ã€‚ç»§ç»­å—ï¼Ÿ`)) {
        this.value = '';
        return;
      }
    }
    
    // æ¸…é™¤æ—§é”™è¯¯é¢æ¿
    const oldPanel = document.querySelector('.error-panel');
    if (oldPanel) oldPanel.remove();
    
    // è®¾ç½®æ’­æ”¾å™¨
    isVideo = file.type.startsWith('video/');
    mediaTypeIndicator.textContent = isVideo ? 'è§†é¢‘æ¨¡å¼(åŠ è½½ä¸­...)' : 'éŸ³é¢‘æ¨¡å¼';
    mediaPlayer.classList.toggle('video-mode', isVideo);
    mediaPlayer.classList.toggle('audio-mode', !isVideo);
    
    const url = URL.createObjectURL(file);
    mediaPlayer.src = url;
    
    // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
    mediaPlayer.onerror = null;
    mediaPlayer.onloadedmetadata = null;
    
    // è®¾ç½®è¶…æ—¶æ£€æµ‹
    let loadTimeout = setTimeout(() => {
      if (mediaPlayer.readyState < 1) {
        console.warn('åª’ä½“åŠ è½½è¶…æ—¶ï¼Œå¯èƒ½æ˜¯æ ¼å¼é—®é¢˜');
        showErrorPanel(file, 'åŠ è½½è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç¼–ç ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸåã€‚');
      }
    }, 10000); // 10ç§’è¶…æ—¶
    
    // æˆåŠŸåŠ è½½
    mediaPlayer.onloadedmetadata = function() {
      clearTimeout(loadTimeout);
      console.log('âœ… åª’ä½“åŠ è½½æˆåŠŸ! æ—¶é•¿:', mediaPlayer.duration.toFixed(1) + 'ç§’');
      mediaTypeIndicator.textContent = isVideo ? 'è§†é¢‘æ¨¡å¼ âœ…' : 'éŸ³é¢‘æ¨¡å¼ âœ…';
      
      if (subtitles.length > 0) {
        subtitles = fixTimestamps(subtitles, mediaPlayer.duration);
        renderText();
      }
    };
    
    // é”™è¯¯å¤„ç†
    mediaPlayer.onerror = function() {
      clearTimeout(loadTimeout);
      console.error('åª’ä½“åŠ è½½å¤±è´¥:', mediaPlayer.error);
      
      let errorMsg = 'æœªçŸ¥é”™è¯¯';
      if (mediaPlayer.error) {
        switch(mediaPlayer.error.code) {
          case 1: errorMsg = 'åŠ è½½è¢«ç”¨æˆ·ä¸­æ­¢'; break;
          case 2: errorMsg = 'ç½‘ç»œé”™è¯¯'; break;
          case 3: errorMsg = 'è§£ç é”™è¯¯ - è§†é¢‘ç¼–ç ä¸æ”¯æŒ'; break;
          case 4: errorMsg = 'æ ¼å¼ä¸æ”¯æŒ - å¯èƒ½æ˜¯H.265ç¼–ç '; break;
        }
      }
      
      showErrorPanel(file, `é”™è¯¯: ${errorMsg}\nä½ çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒæ­¤è§†é¢‘ç¼–ç ã€‚`);
    };
    
    // å°è¯•æ’­æ”¾ä¸€å°æ®µä»¥ç¡®è®¤å…¼å®¹æ€§
    setTimeout(() => {
      if (mediaPlayer.readyState === 0) {
        console.log('åª’ä½“æœªå¼€å§‹åŠ è½½ï¼Œå°è¯•è§¦å‘åŠ è½½');
        mediaPlayer.load();
      }
    }, 1000);
  });

  // å­—å¹•æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
  srtFileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('å­—å¹•æ–‡ä»¶å·²é€‰æ‹©:', file.name);
    const reader = new FileReader();
    
    reader.onload = function() {
      console.log('å¼€å§‹è§£æå­—å¹•æ–‡ä»¶å†…å®¹...');
      const raw = parseSRT(reader.result);
      
      if (raw.length === 0) {
        alert('æ— æ³•è§£æå­—å¹•æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦ä¸ºSRT');
        return;
      }
      
      subtitles = raw;
      
      if (mediaPlayer.duration && mediaPlayer.duration > 0) {
        subtitles = fixTimestamps(subtitles, mediaPlayer.duration);
      }
      
      renderText();
    };
    
    reader.readAsText(file);
  });

  // è·ŸéšæŒ‰é’®ç‚¹å‡»äº‹ä»¶
  followBtn.addEventListener('click', function() {
    if (currentLineIndex !== -1) {
      scrollToCurrentLine();
      followBtn.classList.add('active');
      setTimeout(() => followBtn.classList.remove('active'), 300);
    }
  });

  // åª’ä½“æ—¶é—´æ›´æ–°äº‹ä»¶
  mediaPlayer.addEventListener('timeupdate', updateHighlight);

  // æ·»åŠ æµ‹è¯•æŒ‰é’®
  setTimeout(() => {
    const testBtn = document.createElement('button');
    testBtn.className = 'action-btn success';
    testBtn.innerHTML = 'ğŸ¬ æµ‹è¯•ï¼šåŠ è½½ç¤ºä¾‹è§†é¢‘';
    testBtn.style.marginLeft = '10px';
    
    testBtn.onclick = function() {
      mediaPlayer.src = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
      mediaPlayer.classList.remove('audio-mode');
      mediaPlayer.classList.add('video-mode');
      mediaTypeIndicator.textContent = 'è§†é¢‘æ¨¡å¼(æµ‹è¯•)';
      mediaPlayer.load();
      alert('æ­£åœ¨åŠ è½½æµ‹è¯•è§†é¢‘...å¦‚æœè¿™ä¸ªèƒ½æ’­ä½†ä½ çš„è§†é¢‘ä¸èƒ½ï¼Œè¯´æ˜æ˜¯ç¼–ç é—®é¢˜ã€‚');
    };
    
    const leftControls = document.querySelector('.left-controls');
    if (leftControls) {
      leftControls.appendChild(testBtn);
    }
  }, 1000);

  // åˆå§‹æ¸²æŸ“
  renderText();
  
  console.log('Media Reader åˆå§‹åŒ–å®Œæˆ');
});
</script>

</body>
</html>